<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ Ã— Firestore</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.8; }
    #text { font-size: 1.2em; background: #f0f0f0; padding: 10px; }
    #input { width: 100%; font-size: 1.2em; margin-top: 10px; }
    #result { margin-top: 10px; font-weight: bold; }
    #ranking li { margin-bottom: 4px; }
  </style>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      orderBy, query, serverTimestamp, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqDSPE_HkPbi-J-SqPL4Ys-wR4RaA8wKA",
      authDomain: "otonano-typing-game.firebaseapp.com",
      projectId: "otonano-typing-game",
      storageBucket: "otonano-typing-game.appspot.com",
      messagingSenderId: "475283850178",
      appId: "1:475283850178:web:193d28f17be20a232f4c5b",
      measurementId: "G-JE1X0NCNHB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const texts = [
      "ã“ã‚“ã«ã¡ã¯ã€ã“ã‚Œã¯ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã§ã™ã€‚",
      "æ¯æ—¥å°‘ã—ãšã¤ä¸Šé”ã—ã¾ã—ã‚‡ã†ï¼",
      "JavaScriptã¯æ¥½ã—ã„è¨€èªã§ã™ã€‚",
      "ç©ºã¯é’ãã¦æ°—æŒã¡ã„ã„ã§ã™ã­ã€‚",
      "æ­£ç¢ºã•ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã®ä¸¡æ–¹ãŒå¤§åˆ‡ã§ã™ã€‚"
    ];

    let target = "";
    let startTime = 0;
    let ended = false;

    function setNewText() {
      target = texts[Math.floor(Math.random() * texts.length)];
      document.getElementById("text").textContent = target;
      const input = document.getElementById("input");
      input.value = "";
      input.disabled = false;
      input.focus();
      ended = false;
      startTime = 0;
      document.getElementById("result").textContent = "";
      document.getElementById("submitBtn").disabled = true;
    }

    window.addEventListener("DOMContentLoaded", () => {
      const inputBox = document.getElementById("input");
      const submitBtn = document.getElementById("submitBtn");

      inputBox.addEventListener("input", () => {
        const input = inputBox.value;
        if (input === target && !ended) {
          ended = true;
          const endTime = Date.now();
          const seconds = (endTime - startTime) / 1000;
          const wpm = Math.round((input.length / 5) / (seconds / 60));
          document.getElementById("result").textContent = `å®Œäº†ï¼WPM: ${wpm}`;
          submitBtn.disabled = false;
          submitBtn.dataset.wpm = wpm;
        } else if (input.length === 1 && startTime === 0) {
          startTime = Date.now();
        }
      });

      submitBtn.addEventListener("click", async () => {
        const name = document.getElementById("name").value;
        const wpm = parseInt(submitBtn.dataset.wpm);
        if (!name || isNaN(wpm)) {
          alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        try {
          await addDoc(collection(db, "scores"), {
            name: name,
            wpm: wpm,
            timestamp: serverTimestamp()
          });
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
          loadRanking();
          setNewText();
        } catch (error) {
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error);
        }
      });

      async function loadRanking() {
        const list = document.getElementById("ranking");
        list.innerHTML = "";
        const q = query(collection(db, "scores"), orderBy("wpm", "desc"), limit(10));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement("li");
          li.textContent = `${data.name} - ${data.wpm} WPM`;
          list.appendChild(li);
        });
      }

      loadRanking();
      setNewText();
    });
  </script>
</head>
<body>
  <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</h1>
  <p id="text">èª­ã¿è¾¼ã¿ä¸­...</p>
  <input type="text" id="input" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°" disabled />
  <div id="result"></div>

  <h3>åå‰ã¨ä¸€ç·’ã«é€ä¿¡</h3>
  <input type="text" id="name" placeholder="ã‚ãªãŸã®åå‰" />
  <button id="submitBtn" disabled>ã‚¹ã‚³ã‚¢é€ä¿¡</button>

  <h2>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP10</h2>
  <ul id="ranking"></ul>
</body>
</html>
